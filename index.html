<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de KPIs Completo - Manuten√ß√£o TI</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        h1 {
            color: #667eea;
            margin-bottom: 5px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .tab-button {
            background: white;
            color: #667eea;
            padding: 15px 30px;
            border: 2px solid #667eea;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab-button:hover {
            background: #667eea;
            color: white;
        }

        .tab-button.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            margin-top: 10px;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        .kpi-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .kpi-title {
            color: #666;
            font-size: 12px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .kpi-value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .kpi-meta {
            color: #999;
            font-size: 11px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .chart-container h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .data-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
            font-size: 13px;
        }

        .data-table th,
        .data-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table th {
            background: #f5f5f5;
            font-weight: 600;
            color: #555;
        }

        .data-table tr:hover {
            background: #f9f9f9;
        }

        .delete-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            width: auto;
            margin: 0;
        }

        .delete-btn:hover {
            background: #ff3838;
        }

        .export-btn {
            background: #2ecc71;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 10px 5px;
            width: auto;
        }

        .export-btn:hover {
            background: #27ae60;
        }

        .clear-btn {
            background: #e74c3c;
            margin-left: 10px;
        }

        .clear-btn:hover {
            background: #c0392b;
        }

        .storage-info {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            color: #666;
            font-size: 14px;
        }

        .storage-info strong {
            color: #667eea;
        }

        @media (max-width: 968px) {
            .main-grid,
            .charts-grid,
            .kpi-cards {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Sistema de KPIs Completo</h1>
            <p class="subtitle">Acompanhamento de Desempenho - Manuten√ß√£o e Infraestrutura TI</p>
        </header>

        <div class="storage-info">
            üíæ Os dados s√£o salvos automaticamente no seu navegador. <strong id="lastSaved">Nunca salvo</strong>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-button active" onclick="changeTab('vendas')">üìà Vendas</button>
            <button class="tab-button" onclick="changeTab('financeiro')">üí∞ Financeiro</button>
            <button class="tab-button" onclick="changeTab('operacional')">‚öôÔ∏è Operacional</button>
            <button class="tab-button" onclick="changeTab('dashboard')">üìä Dashboard</button>
        </div>

        <!-- Tab Vendas -->
        <div id="vendas" class="tab-content active">
            <div class="main-grid">
                <!-- Or√ßamentos -->
                <div class="card">
                    <h2>üìù Registrar Or√ßamentos</h2>
                    <div class="input-group">
                        <label for="orcamento-mes">M√™s</label>
                        <select id="orcamento-mes"></select>
                    </div>
                    <div class="input-group">
                        <label for="orcamentos-enviados">Or√ßamentos Enviados</label>
                        <input type="number" id="orcamentos-enviados" min="0" placeholder="Ex: 10">
                    </div>
                    <div class="input-group">
                        <label for="orcamentos-fechados">Or√ßamentos Fechados</label>
                        <input type="number" id="orcamentos-fechados" min="0" placeholder="Ex: 3">
                    </div>
                    <button onclick="adicionarOrcamento()">Adicionar</button>
                </div>

                <!-- Clientes -->
                <div class="card">
                    <h2>üë• Clientes Ativos</h2>
                    <div class="input-group">
                        <label for="cliente-mes">M√™s</label>
                        <select id="cliente-mes"></select>
                    </div>
                    <div class="input-group">
                        <label for="clientes-ativos">Clientes Ativos</label>
                        <input type="number" id="clientes-ativos" min="0" placeholder="Ex: 5">
                    </div>
                    <div class="input-group">
                        <label for="clientes-recorrentes">Clientes Recorrentes</label>
                        <input type="number" id="clientes-recorrentes" min="0" placeholder="Ex: 2">
                    </div>
                    <button onclick="adicionarClientes()">Adicionar</button>
                </div>

                <!-- Leads -->
                <div class="card">
                    <h2>üìû Convers√£o de Leads</h2>
                    <div class="input-group">
                        <label for="lead-mes">M√™s</label>
                        <select id="lead-mes"></select>
                    </div>
                    <div class="input-group">
                        <label for="leads-total">Total de Contatos</label>
                        <input type="number" id="leads-total" min="0" placeholder="Ex: 20">
                    </div>
                    <div class="input-group">
                        <label for="leads-convertidos">Contatos Convertidos</label>
                        <input type="number" id="leads-convertidos" min="0" placeholder="Ex: 5">
                    </div>
                    <button onclick="adicionarLeads()">Adicionar</button>
                </div>
            </div>
        </div>

        <!-- Tab Financeiro -->
        <div id="financeiro" class="tab-content">
            <div class="main-grid">
                <!-- Faturamento -->
                <div class="card">
                    <h2>üíµ Faturamento Mensal</h2>
                    <div class="input-group">
                        <label for="fat-mes">M√™s</label>
                        <select id="fat-mes"></select>
                    </div>
                    <div class="input-group">
                        <label for="faturamento-valor">Faturamento (R$)</label>
                        <input type="number" id="faturamento-valor" min="0" step="0.01" placeholder="Ex: 15000.00">
                    </div>
                    <div class="input-group">
                        <label for="servicos-realizados">Servi√ßos Realizados</label>
                        <input type="number" id="servicos-realizados" min="0" placeholder="Ex: 20">
                    </div>
                    <button onclick="adicionarFaturamento()">Adicionar</button>
                </div>

                <!-- Mix de Clientes -->
                <div class="card">
                    <h2>üè¢ Mix B2B vs B2C</h2>
                    <div class="input-group">
                        <label for="mix-mes">M√™s</label>
                        <select id="mix-mes"></select>
                    </div>
                    <div class="input-group">
                        <label for="faturamento-b2b">Faturamento B2B (R$)</label>
                        <input type="number" id="faturamento-b2b" min="0" step="0.01" placeholder="Ex: 10000.00">
                    </div>
                    <div class="input-group">
                        <label for="faturamento-b2c">Faturamento B2C (R$)</label>
                        <input type="number" id="faturamento-b2c" min="0" step="0.01" placeholder="Ex: 5000.00">
                    </div>
                    <button onclick="adicionarMix()">Adicionar</button>
                </div>

                <!-- Margem de Lucro -->
                <div class="card">
                    <h2>üìä Margem de Lucro</h2>
                    <div class="input-group">
                        <label for="margem-mes">M√™s</label>
                        <select id="margem-mes"></select>
                    </div>
                    <div class="input-group">
                        <label for="receita-total">Receita Total (R$)</label>
                        <input type="number" id="receita-total" min="0" step="0.01" placeholder="Ex: 15000.00">
                    </div>
                    <div class="input-group">
                        <label for="custos-total">Custos Totais (R$)</label>
                        <input type="number" id="custos-total" min="0" step="0.01" placeholder="Ex: 8000.00">
                    </div>
                    <button onclick="adicionarMargem()">Adicionar</button>
                </div>
            </div>
        </div>

        <!-- Tab Operacional -->
        <div id="operacional" class="tab-content">
            <div class="main-grid">
                <!-- Tempo de Resposta -->
                <div class="card">
                    <h2>‚è±Ô∏è Tempo de Resposta</h2>
                    <div class="input-group">
                        <label for="tempo-mes">M√™s</label>
                        <select id="tempo-mes"></select>
                    </div>
                    <div class="input-group">
                        <label for="tempo-medio">Tempo M√©dio (horas)</label>
                        <input type="number" id="tempo-medio" min="0" step="0.5" placeholder="Ex: 2.5">
                    </div>
                    <button onclick="adicionarTempo()">Adicionar</button>
                </div>

                <!-- NPS -->
                <div class="card">
                    <h2>‚≠ê Satisfa√ß√£o (NPS)</h2>
                    <div class="input-group">
                        <label for="nps-mes">M√™s</label>
                        <select id="nps-mes"></select>
                    </div>
                    <div class="input-group">
                        <label for="nps-media">Nota M√©dia (0-10)</label>
                        <input type="number" id="nps-media" min="0" max="10" step="0.1" placeholder="Ex: 8.5">
                    </div>
                    <div class="input-group">
                        <label for="nps-respostas">N√∫mero de Respostas</label>
                        <input type="number" id="nps-respostas" min="0" placeholder="Ex: 15">
                    </div>
                    <button onclick="adicionarNPS()">Adicionar</button>
                </div>

                <!-- Utiliza√ß√£o da Equipe -->
                <div class="card">
                    <h2>üë∑ Utiliza√ß√£o da Equipe</h2>
                    <div class="input-group">
                        <label for="util-mes">M√™s</label>
                        <select id="util-mes"></select>
                    </div>
                    <div class="input-group">
                        <label for="horas-trabalhadas">Horas Trabalhadas</label>
                        <input type="number" id="horas-trabalhadas" min="0" placeholder="Ex: 320">
                    </div>
                    <div class="input-group">
                        <label for="horas-disponiveis">Horas Dispon√≠veis</label>
                        <input type="number" id="horas-disponiveis" min="0" placeholder="Ex: 400">
                    </div>
                    <button onclick="adicionarUtilizacao()">Adicionar</button>
                </div>
            </div>
        </div>

        <!-- Tab Dashboard -->
        <div id="dashboard" class="tab-content">
            <div style="text-align: right; margin-bottom: 20px;">
                <button class="export-btn" onclick="exportarDados()">üìä Exportar para Excel</button>
                <button class="export-btn clear-btn" onclick="limparTodosDados()">üóëÔ∏è Limpar Todos os Dados</button>
            </div>

            <!-- KPI Cards -->
            <div class="kpi-cards">
                <div class="kpi-card">
                    <div class="kpi-title">Taxa de Convers√£o</div>
                    <div class="kpi-value" id="taxa-conversao">0%</div>
                    <div class="kpi-meta">Meta: 20-30%</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">Clientes Ativos</div>
                    <div class="kpi-value" id="total-clientes">0</div>
                    <div class="kpi-meta">√öltimo m√™s</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">Ticket M√©dio</div>
                    <div class="kpi-value" id="ticket-medio">R$ 0</div>
                    <div class="kpi-meta">Por servi√ßo</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">Faturamento</div>
                    <div class="kpi-value" id="faturamento-total">R$ 0</div>
                    <div class="kpi-meta">√öltimo m√™s</div>
                </div>
                <div class="kpi-card" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white;">
                    <div class="kpi-title" style="color: rgba(255,255,255,0.9);">üí∞ Lucro L√≠quido</div>
                    <div class="kpi-value" style="color: white;" id="lucro-liquido">R$ 0</div>
                    <div class="kpi-meta" style="color: rgba(255,255,255,0.8);" id="lucro-meta">√öltimo m√™s</div>
                </div>
                <div class="kpi-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="kpi-title" style="color: rgba(255,255,255,0.9);">üìä Margem de Lucro</div>
                    <div class="kpi-value" style="color: white;" id="margem-lucro-card">0%</div>
                    <div class="kpi-meta" style="color: rgba(255,255,255,0.8);">Meta: 40-60%</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">Taxa Recorr√™ncia</div>
                    <div class="kpi-value" id="taxa-recorrencia">0%</div>
                    <div class="kpi-meta">Meta: 30-40%</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">NPS M√©dio</div>
                    <div class="kpi-value" id="nps-medio">0</div>
                    <div class="kpi-meta">Meta: > 8</div>
                </div>
            </div>

            <!-- Gr√°ficos -->
            <div class="charts-grid">
                <div class="chart-container">
                    <h3>üìà Taxa de Convers√£o de Or√ßamentos</h3>
                    <canvas id="chartConversao"></canvas>
                </div>

                <div class="chart-container">
                    <h3>üë• Evolu√ß√£o de Clientes</h3>
                    <canvas id="chartClientes"></canvas>
                </div>

                <div class="chart-container">
                    <h3>üí∞ Faturamento Mensal</h3>
                    <canvas id="chartFaturamento"></canvas>
                </div>

                <div class="chart-container" style="background: linear-gradient(135deg, rgba(46, 204, 113, 0.1) 0%, rgba(39, 174, 96, 0.1) 100%);">
                    <h3>üíµ Lucro L√≠quido Mensal</h3>
                    <canvas id="chartLucro"></canvas>
                </div>

                <div class="chart-container">
                    <h3>üè¢ Mix B2B vs B2C</h3>
                    <canvas id="chartMix"></canvas>
                </div>

                <div class="chart-container">
                    <h3>‚≠ê Satisfa√ß√£o do Cliente (NPS)</h3>
                    <canvas id="chartNPS"></canvas>
                </div>

                <div class="chart-container">
                    <h3>üìä Margem de Lucro (%)</h3>
                    <canvas id="chartMargem"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dados
        let dados = {
            orcamentos: [],
            clientes: [],
            leads: [],
            faturamento: [],
            mix: [],
            margem: [],
            tempo: [],
            nps: [],
            utilizacao: []
        };

        // Charts
        let charts = {};

        // Meses
        const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                      'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

        // Inicializa√ß√£o
        window.onload = function() {
            inicializarSelects();
            carregarDados();
            inicializarGraficos();
            atualizarDashboard();
        };

        // Fun√ß√µes de LocalStorage
        function salvarDados() {
            localStorage.setItem('kpiData', JSON.stringify(dados));
            const agora = new Date().toLocaleString('pt-BR');
            localStorage.setItem('kpiLastSaved', agora);
            document.getElementById('lastSaved').textContent = `√öltimo salvamento: ${agora}`;
        }

        function carregarDados() {
            const savedData = localStorage.getItem('kpiData');
            if (savedData) {
                dados = JSON.parse(savedData);
                const lastSaved = localStorage.getItem('kpiLastSaved');
                if (lastSaved) {
                    document.getElementById('lastSaved').textContent = `√öltimo salvamento: ${lastSaved}`;
                }
            }
        }

        function limparTodosDados() {
            if (confirm('‚ö†Ô∏è Tem certeza que deseja limpar TODOS os dados? Esta a√ß√£o n√£o pode ser desfeita!')) {
                localStorage.clear();
                dados = {
                    orcamentos: [],
                    clientes: [],
                    leads: [],
                    faturamento: [],
                    mix: [],
                    margem: [],
                    tempo: [],
                    nps: [],
                    utilizacao: []
                };
                atualizarDashboard();
                alert('‚úÖ Todos os dados foram limpos!');
            }
        }

        function exportarDados() {
            // Criar um novo workbook
            const wb = XLSX.utils.book_new();

            // Aba 1: Resumo KPIs
            const resumoData = [
                ['RESUMO DE KPIs - SISTEMA DE GEST√ÉO'],
                ['Data de Exporta√ß√£o:', new Date().toLocaleString('pt-BR')],
                [],
                ['KPI', 'Valor Atual', 'Meta', 'Status'],
            ];

            // Adicionar KPIs ao resumo
            const taxaConv = dados.orcamentos.length > 0 ? 
                (dados.orcamentos.reduce((acc, curr) => acc + parseFloat(curr.taxa), 0) / dados.orcamentos.length).toFixed(1) + '%' : '0%';
            resumoData.push(['Taxa de Convers√£o de Or√ßamentos', taxaConv, '20-30%', parseFloat(taxaConv) >= 20 ? 'Atingido' : 'Abaixo']);

            if (dados.clientes.length > 0) {
                const ultimo = dados.clientes[dados.clientes.length - 1];
                resumoData.push(['Clientes Ativos', ultimo.ativos, '-', 'OK']);
                
                if (ultimo.recorrentes && ultimo.ativos > 0) {
                    const taxaRec = ((ultimo.recorrentes / ultimo.ativos) * 100).toFixed(1) + '%';
                    resumoData.push(['Taxa de Recorr√™ncia', taxaRec, '30-40%', parseFloat(taxaRec) >= 30 ? 'Atingido' : 'Abaixo']);
                }
            }

            if (dados.faturamento.length > 0) {
                const ultimo = dados.faturamento[dados.faturamento.length - 1];
                resumoData.push(['Faturamento Mensal', 'R$ ' + ultimo.valor.toLocaleString('pt-BR'), '-', 'OK']);
                resumoData.push(['Ticket M√©dio', 'R$ ' + parseFloat(ultimo.ticketMedio).toLocaleString('pt-BR'), '-', 'OK']);
            }

            if (dados.nps.length > 0) {
                const npsMedia = (dados.nps.reduce((acc, curr) => acc + parseFloat(curr.media), 0) / dados.nps.length).toFixed(1);
                resumoData.push(['NPS M√©dio', npsMedia, '> 8.0', parseFloat(npsMedia) >= 8 ? 'Atingido' : 'Abaixo']);
            }

            const wsResumo = XLSX.utils.aoa_to_sheet(resumoData);
            
            // Ajustar largura das colunas do resumo
            wsResumo['!cols'] = [
                { wch: 35 },  // KPI
                { wch: 15 },  // Valor Atual
                { wch: 12 },  // Meta
                { wch: 12 }   // Status
            ];

            XLSX.utils.book_append_sheet(wb, wsResumo, 'Resumo KPIs');

            // Aba 2: Or√ßamentos
            if (dados.orcamentos.length > 0) {
                const orcData = [
                    ['CONVERS√ÉO DE OR√áAMENTOS'],
                    [],
                    ['M√™s', 'Or√ßamentos Enviados', 'Or√ßamentos Fechados', 'Taxa de Convers√£o (%)']
                ];
                
                dados.orcamentos.forEach(item => {
                    orcData.push([item.mes, item.enviados, item.fechados, parseFloat(item.taxa)]);
                });

                // Adicionar linha de totais
                const totalEnviados = dados.orcamentos.reduce((acc, curr) => acc + curr.enviados, 0);
                const totalFechados = dados.orcamentos.reduce((acc, curr) => acc + curr.fechados, 0);
                const mediaConversao = (dados.orcamentos.reduce((acc, curr) => acc + parseFloat(curr.taxa), 0) / dados.orcamentos.length).toFixed(1);
                
                orcData.push([]);
                orcData.push(['TOTAIS/M√âDIAS', totalEnviados, totalFechados, parseFloat(mediaConversao)]);

                const wsOrc = XLSX.utils.aoa_to_sheet(orcData);
                wsOrc['!cols'] = [
                    { wch: 15 },
                    { wch: 20 },
                    { wch: 22 },
                    { wch: 22 }
                ];
                XLSX.utils.book_append_sheet(wb, wsOrc, 'Or√ßamentos');
            }

            // Aba 3: Clientes
            if (dados.clientes.length > 0) {
                const clientesData = [
                    ['CLIENTES ATIVOS'],
                    [],
                    ['M√™s', 'Clientes Ativos', 'Clientes Recorrentes', 'Taxa de Recorr√™ncia (%)']
                ];
                
                dados.clientes.forEach(item => {
                    const taxaRec = item.recorrentes && item.ativos > 0 ? 
                        ((item.recorrentes / item.ativos) * 100).toFixed(1) : 0;
                    clientesData.push([item.mes, item.ativos, item.recorrentes || 0, parseFloat(taxaRec)]);
                });

                const wsClientes = XLSX.utils.aoa_to_sheet(clientesData);
                wsClientes['!cols'] = [
                    { wch: 15 },
                    { wch: 18 },
                    { wch: 22 },
                    { wch: 25 }
                ];
                XLSX.utils.book_append_sheet(wb, wsClientes, 'Clientes');
            }

            // Aba 4: Leads
            if (dados.leads.length > 0) {
                const leadsData = [
                    ['CONVERS√ÉO DE LEADS'],
                    [],
                    ['M√™s', 'Total de Contatos', 'Contatos Convertidos', 'Taxa de Convers√£o (%)']
                ];
                
                dados.leads.forEach(item => {
                    leadsData.push([item.mes, item.total, item.convertidos, parseFloat(item.taxa)]);
                });

                const wsLeads = XLSX.utils.aoa_to_sheet(leadsData);
                wsLeads['!cols'] = [
                    { wch: 15 },
                    { wch: 20 },
                    { wch: 22 },
                    { wch: 22 }
                ];
                XLSX.utils.book_append_sheet(wb, wsLeads, 'Leads');
            }

            // Aba 5: Faturamento
            if (dados.faturamento.length > 0) {
                const fatData = [
                    ['FATURAMENTO E TICKET M√âDIO'],
                    [],
                    ['M√™s', 'Faturamento (R$)', 'Servi√ßos Realizados', 'Ticket M√©dio (R$)']
                ];
                
                dados.faturamento.forEach(item => {
                    fatData.push([item.mes, item.valor, item.servicos, parseFloat(item.ticketMedio)]);
                });

                // Totais
                const totalFat = dados.faturamento.reduce((acc, curr) => acc + curr.valor, 0);
                const totalServ = dados.faturamento.reduce((acc, curr) => acc + curr.servicos, 0);
                const ticketMedioGeral = totalServ > 0 ? (totalFat / totalServ).toFixed(2) : 0;
                
                fatData.push([]);
                fatData.push(['TOTAIS', totalFat, totalServ, parseFloat(ticketMedioGeral)]);

                const wsFat = XLSX.utils.aoa_to_sheet(fatData);
                wsFat['!cols'] = [
                    { wch: 15 },
                    { wch: 18 },
                    { wch: 20 },
                    { wch: 18 }
                ];
                XLSX.utils.book_append_sheet(wb, wsFat, 'Faturamento');
            }

            // Aba 6: Mix B2B vs B2C
            if (dados.mix.length > 0) {
                const mixData = [
                    ['MIX B2B vs B2C'],
                    [],
                    ['M√™s', 'Faturamento B2B (R$)', '% B2B', 'Faturamento B2C (R$)', '% B2C', 'Total (R$)']
                ];
                
                dados.mix.forEach(item => {
                    const total = item.b2b + item.b2c;
                    mixData.push([
                        item.mes, 
                        item.b2b, 
                        parseFloat(item.percB2B), 
                        item.b2c, 
                        parseFloat(item.percB2C), 
                        total
                    ]);
                });

                // Totais
                const totalB2B = dados.mix.reduce((acc, curr) => acc + curr.b2b, 0);
                const totalB2C = dados.mix.reduce((acc, curr) => acc + curr.b2c, 0);
                const totalGeral = totalB2B + totalB2C;
                const percB2BTotal = totalGeral > 0 ? ((totalB2B / totalGeral) * 100).toFixed(1) : 0;
                const percB2CTotal = totalGeral > 0 ? ((totalB2C / totalGeral) * 100).toFixed(1) : 0;
                
                mixData.push([]);
                mixData.push(['TOTAIS', totalB2B, parseFloat(percB2BTotal), totalB2C, parseFloat(percB2CTotal), totalGeral]);

                const wsMix = XLSX.utils.aoa_to_sheet(mixData);
                wsMix['!cols'] = [
                    { wch: 15 },
                    { wch: 20 },
                    { wch: 10 },
                    { wch: 20 },
                    { wch: 10 },
                    { wch: 15 }
                ];
                XLSX.utils.book_append_sheet(wb, wsMix, 'Mix B2B-B2C');
            }

            // Aba 7: Margem de Lucro
            if (dados.margem.length > 0) {
                const margemData = [
                    ['MARGEM DE LUCRO'],
                    [],
                    ['M√™s', 'Receita Total (R$)', 'Custos Totais (R$)', 'Lucro (R$)', 'Margem (%)']
                ];
                
                dados.margem.forEach(item => {
                    const lucro = item.receita - item.custos;
                    margemData.push([
                        item.mes, 
                        item.receita, 
                        item.custos, 
                        lucro, 
                        parseFloat(item.margem)
                    ]);
                });

                // Totais
                const totalReceita = dados.margem.reduce((acc, curr) => acc + curr.receita, 0);
                const totalCustos = dados.margem.reduce((acc, curr) => acc + curr.custos, 0);
                const totalLucro = totalReceita - totalCustos;
                const margemTotal = totalReceita > 0 ? ((totalLucro / totalReceita) * 100).toFixed(1) : 0;
                
                margemData.push([]);
                margemData.push(['TOTAIS', totalReceita, totalCustos, totalLucro, parseFloat(margemTotal)]);

                const wsMargem = XLSX.utils.aoa_to_sheet(margemData);
                wsMargem['!cols'] = [
                    { wch: 15 },
                    { wch: 20 },
                    { wch: 20 },
                    { wch: 15 },
                    { wch: 15 }
                ];
                XLSX.utils.book_append_sheet(wb, wsMargem, 'Margem Lucro');
            }

            // Aba 8: NPS
            if (dados.nps.length > 0) {
                const npsData = [
                    ['SATISFA√á√ÉO DO CLIENTE (NPS)'],
                    [],
                    ['M√™s', 'Nota M√©dia', 'N√∫mero de Respostas']
                ];
                
                dados.nps.forEach(item => {
                    npsData.push([item.mes, item.media, item.respostas]);
                });

                // M√©dia geral
                const npsMediaGeral = (dados.nps.reduce((acc, curr) => acc + parseFloat(curr.media), 0) / dados.nps.length).toFixed(1);
                const totalRespostas = dados.nps.reduce((acc, curr) => acc + curr.respostas, 0);
                
                npsData.push([]);
                npsData.push(['M√âDIA GERAL', parseFloat(npsMediaGeral), totalRespostas]);

                const wsNPS = XLSX.utils.aoa_to_sheet(npsData);
                wsNPS['!cols'] = [
                    { wch: 15 },
                    { wch: 15 },
                    { wch: 22 }
                ];
                XLSX.utils.book_append_sheet(wb, wsNPS, 'NPS');
            }

            // Aba 9: Tempo de Resposta
            if (dados.tempo.length > 0) {
                const tempoData = [
                    ['TEMPO DE RESPOSTA'],
                    [],
                    ['M√™s', 'Tempo M√©dio (horas)']
                ];
                
                dados.tempo.forEach(item => {
                    tempoData.push([item.mes, item.tempo]);
                });

                // M√©dia
                const tempoMedioGeral = (dados.tempo.reduce((acc, curr) => acc + parseFloat(curr.tempo), 0) / dados.tempo.length).toFixed(1);
                
                tempoData.push([]);
                tempoData.push(['M√âDIA GERAL', parseFloat(tempoMedioGeral)]);

                const wsTempo = XLSX.utils.aoa_to_sheet(tempoData);
                wsTempo['!cols'] = [
                    { wch: 15 },
                    { wch: 22 }
                ];
                XLSX.utils.book_append_sheet(wb, wsTempo, 'Tempo Resposta');
            }

            // Aba 10: Utiliza√ß√£o da Equipe
            if (dados.utilizacao.length > 0) {
                const utilData = [
                    ['UTILIZA√á√ÉO DA EQUIPE'],
                    [],
                    ['M√™s', 'Horas Trabalhadas', 'Horas Dispon√≠veis', 'Taxa de Utiliza√ß√£o (%)']
                ];
                
                dados.utilizacao.forEach(item => {
                    utilData.push([item.mes, item.trabalhadas, item.disponiveis, parseFloat(item.taxa)]);
                });

                // Totais
                const totalTrabalhadas = dados.utilizacao.reduce((acc, curr) => acc + curr.trabalhadas, 0);
                const totalDisponiveis = dados.utilizacao.reduce((acc, curr) => acc + curr.disponiveis, 0);
                const taxaUtilMedia = totalDisponiveis > 0 ? ((totalTrabalhadas / totalDisponiveis) * 100).toFixed(1) : 0;
                
                utilData.push([]);
                utilData.push(['TOTAIS', totalTrabalhadas, totalDisponiveis, parseFloat(taxaUtilMedia)]);

                const wsUtil = XLSX.utils.aoa_to_sheet(utilData);
                wsUtil['!cols'] = [
                    { wch: 15 },
                    { wch: 20 },
                    { wch: 20 },
                    { wch: 25 }
                ];
                XLSX.utils.book_append_sheet(wb, wsUtil, 'Utiliza√ß√£o Equipe');
            }

            // Salvar arquivo
            const fileName = `KPIs-Dashboard-${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            alert('‚úÖ Relat√≥rio exportado com sucesso!\n\nArquivo: ' + fileName);
        }

        // Inicializar selects de m√™s
        function inicializarSelects() {
            const selects = ['orcamento-mes', 'cliente-mes', 'lead-mes', 'fat-mes', 'mix-mes', 
                           'margem-mes', 'tempo-mes', 'nps-mes', 'util-mes'];
            const mesAtual = new Date().getMonth();
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                meses.forEach((mes, index) => {
                    const option = document.createElement('option');
                    option.value = mes;
                    option.textContent = mes;
                    if (index === mesAtual) option.selected = true;
                    select.appendChild(option);
                });
            });
        }

        // Fun√ß√µes de adi√ß√£o de dados
        function adicionarOrcamento() {
            const mes = document.getElementById('orcamento-mes').value;
            const enviados = parseInt(document.getElementById('orcamentos-enviados').value);
            const fechados = parseInt(document.getElementById('orcamentos-fechados').value);

            if (isNaN(enviados) || isNaN(fechados)) {
                alert('Preencha todos os campos!');
                return;
            }

            if (fechados > enviados) {
                alert('Or√ßamentos fechados n√£o pode ser maior que enviados!');
                return;
            }

            const taxa = enviados > 0 ? ((fechados / enviados) * 100).toFixed(1) : 0;
            dados.orcamentos.push({ mes, enviados, fechados, taxa });
            
            document.getElementById('orcamentos-enviados').value = '';
            document.getElementById('orcamentos-fechados').value = '';
            
            salvarDados();
            atualizarDashboard();
        }

        function adicionarClientes() {
            const mes = document.getElementById('cliente-mes').value;
            const ativos = parseInt(document.getElementById('clientes-ativos').value);
            const recorrentes = parseInt(document.getElementById('clientes-recorrentes').value) || 0;

            if (isNaN(ativos)) {
                alert('Preencha o n√∫mero de clientes ativos!');
                return;
            }

            dados.clientes.push({ mes, ativos, recorrentes });
            
            document.getElementById('clientes-ativos').value = '';
            document.getElementById('clientes-recorrentes').value = '';
            
            salvarDados();
            atualizarDashboard();
        }

        function adicionarLeads() {
            const mes = document.getElementById('lead-mes').value;
            const total = parseInt(document.getElementById('leads-total').value);
            const convertidos = parseInt(document.getElementById('leads-convertidos').value);

            if (isNaN(total) || isNaN(convertidos)) {
                alert('Preencha todos os campos!');
                return;
            }

            const taxa = total > 0 ? ((convertidos / total) * 100).toFixed(1) : 0;
            dados.leads.push({ mes, total, convertidos, taxa });
            
            document.getElementById('leads-total').value = '';
            document.getElementById('leads-convertidos').value = '';
            
            salvarDados();
            atualizarDashboard();
        }

        function adicionarFaturamento() {
            const mes = document.getElementById('fat-mes').value;
            const valor = parseFloat(document.getElementById('faturamento-valor').value);
            const servicos = parseInt(document.getElementById('servicos-realizados').value);

            if (isNaN(valor) || isNaN(servicos)) {
                alert('Preencha todos os campos!');
                return;
            }

            const ticketMedio = servicos > 0 ? (valor / servicos).toFixed(2) : 0;
            dados.faturamento.push({ mes, valor, servicos, ticketMedio });
            
            document.getElementById('faturamento-valor').value = '';
            document.getElementById('servicos-realizados').value = '';
            
            salvarDados();
            atualizarDashboard();
        }

        function adicionarMix() {
            const mes = document.getElementById('mix-mes').value;
            const b2b = parseFloat(document.getElementById('faturamento-b2b').value);
            const b2c = parseFloat(document.getElementById('faturamento-b2c').value);

            if (isNaN(b2b) || isNaN(b2c)) {
                alert('Preencha todos os campos!');
                return;
            }

            const total = b2b + b2c;
            const percB2B = total > 0 ? ((b2b / total) * 100).toFixed(1) : 0;
            const percB2C = total > 0 ? ((b2c / total) * 100).toFixed(1) : 0;
            
            dados.mix.push({ mes, b2b, b2c, percB2B, percB2C });
            
            document.getElementById('faturamento-b2b').value = '';
            document.getElementById('faturamento-b2c').value = '';
            
            salvarDados();
            atualizarDashboard();
        }

        function adicionarMargem() {
            const mes = document.getElementById('margem-mes').value;
            const receita = parseFloat(document.getElementById('receita-total').value);
            const custos = parseFloat(document.getElementById('custos-total').value);

            if (isNaN(receita) || isNaN(custos)) {
                alert('Preencha todos os campos!');
                return;
            }

            const margem = receita > 0 ? (((receita - custos) / receita) * 100).toFixed(1) : 0;
            dados.margem.push({ mes, receita, custos, margem });
            
            document.getElementById('receita-total').value = '';
            document.getElementById('custos-total').value = '';
            
            salvarDados();
            atualizarDashboard();
        }

        function adicionarTempo() {
            const mes = document.getElementById('tempo-mes').value;
            const tempo = parseFloat(document.getElementById('tempo-medio').value);

            if (isNaN(tempo)) {
                alert('Preencha o tempo m√©dio!');
                return;
            }

            dados.tempo.push({ mes, tempo });
            document.getElementById('tempo-medio').value = '';
            
            salvarDados();
            atualizarDashboard();
        }

        function adicionarNPS() {
            const mes = document.getElementById('nps-mes').value;
            const media = parseFloat(document.getElementById('nps-media').value);
            const respostas = parseInt(document.getElementById('nps-respostas').value);

            if (isNaN(media) || isNaN(respostas)) {
                alert('Preencha todos os campos!');
                return;
            }

            dados.nps.push({ mes, media, respostas });
            
            document.getElementById('nps-media').value = '';
            document.getElementById('nps-respostas').value = '';
            
            salvarDados();
            atualizarDashboard();
        }

        function adicionarUtilizacao() {
            const mes = document.getElementById('util-mes').value;
            const trabalhadas = parseFloat(document.getElementById('horas-trabalhadas').value);
            const disponiveis = parseFloat(document.getElementById('horas-disponiveis').value);

            if (isNaN(trabalhadas) || isNaN(disponiveis)) {
                alert('Preencha todos os campos!');
                return;
            }

            const taxa = disponiveis > 0 ? ((trabalhadas / disponiveis) * 100).toFixed(1) : 0;
            dados.utilizacao.push({ mes, trabalhadas, disponiveis, taxa });
            
            document.getElementById('horas-trabalhadas').value = '';
            document.getElementById('horas-disponiveis').value = '';
            
            salvarDados();
            atualizarDashboard();
        }

        // Inicializar gr√°ficos
        function inicializarGraficos() {
            // Gr√°fico de Convers√£o
            charts.conversao = new Chart(document.getElementById('chartConversao'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Taxa de Convers√£o (%)',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });

            // Gr√°fico de Clientes
            charts.clientes = new Chart(document.getElementById('chartClientes'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Clientes Ativos',
                        data: [],
                        backgroundColor: 'rgba(118, 75, 162, 0.8)',
                        borderColor: '#764ba2',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } }
                }
            });

            // Gr√°fico de Faturamento
            charts.faturamento = new Chart(document.getElementById('chartFaturamento'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Faturamento (R$)',
                        data: [],
                        borderColor: '#2ecc71',
                        backgroundColor: 'rgba(46, 204, 113, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } }
                }
            });

            // Gr√°fico Mix B2B/B2C
            charts.mix = new Chart(document.getElementById('chartMix'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'B2B (R$)',
                            data: [],
                            backgroundColor: 'rgba(52, 152, 219, 0.8)',
                        },
                        {
                            label: 'B2C (R$)',
                            data: [],
                            backgroundColor: 'rgba(155, 89, 182, 0.8)',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, stacked: true }, x: { stacked: true } }
                }
            });

            // Gr√°fico NPS
            charts.nps = new Chart(document.getElementById('chartNPS'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'NPS M√©dio',
                        data: [],
                        borderColor: '#f39c12',
                        backgroundColor: 'rgba(243, 156, 18, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, max: 10 } }
                }
            });

            // Gr√°fico Margem
            charts.margem = new Chart(document.getElementById('chartMargem'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Margem de Lucro (%)',
                        data: [],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });

            charts.lucro = new Chart(document.getElementById('chartLucro'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Lucro L√≠quido (R$)',
                        data: [],
                        backgroundColor: 'rgba(46, 204, 113, 0.8)',
                        borderColor: '#2ecc71',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // Atualizar Dashboard
        function atualizarDashboard() {
            if (dados.orcamentos.length > 0) {
                const taxaMedia = dados.orcamentos.reduce((acc, curr) => acc + parseFloat(curr.taxa), 0) / dados.orcamentos.length;
                document.getElementById('taxa-conversao').textContent = taxaMedia.toFixed(1) + '%';
            }

            if (dados.clientes.length > 0) {
                const ultimo = dados.clientes[dados.clientes.length - 1];
                document.getElementById('total-clientes').textContent = ultimo.ativos;
                
                if (ultimo.recorrentes && ultimo.ativos > 0) {
                    const taxaRec = ((ultimo.recorrentes / ultimo.ativos) * 100).toFixed(1);
                    document.getElementById('taxa-recorrencia').textContent = taxaRec + '%';
                }
            }

            if (dados.faturamento.length > 0) {
                const ultimo = dados.faturamento[dados.faturamento.length - 1];
                document.getElementById('faturamento-total').textContent = 'R$ ' + ultimo.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('ticket-medio').textContent = 'R$ ' + parseFloat(ultimo.ticketMedio).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }


            if (dados.margem.length > 0) {
                const ultimaMargem = dados.margem[dados.margem.length - 1];
                const lucro = ultimaMargem.receita - ultimaMargem.custos;
                const margemPerc = parseFloat(ultimaMargem.margem);
                
                document.getElementById('lucro-liquido').textContent = 'R$ ' + lucro.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('margem-lucro-card').textContent = margemPerc.toFixed(1) + '%';

                const metaElement = document.getElementById('lucro-meta');
                if (margemPerc >= 40) {
                    metaElement.textContent = '‚úÖ Meta atingida!';
                } else if (margemPerc >= 30) {
                    metaElement.textContent = '‚ö†Ô∏è Pr√≥ximo da meta';
                } else {
                    metaElement.textContent = '‚ùå Abaixo da meta';
                }
            } else {
                document.getElementById('lucro-liquido').textContent = 'R$ 0';
                document.getElementById('margem-lucro-card').textContent = '0%';
                document.getElementById('lucro-meta').textContent = 'Adicione dados de margem';
            }

            if (dados.nps.length > 0) {
                const npsMedia = dados.nps.reduce((acc, curr) => acc + parseFloat(curr.media), 0) / dados.nps.length;
                document.getElementById('nps-medio').textContent = npsMedia.toFixed(1);
            }

            charts.conversao.data.labels = dados.orcamentos.map(d => d.mes);
            charts.conversao.data.datasets[0].data = dados.orcamentos.map(d => parseFloat(d.taxa));
            charts.conversao.update();

            charts.clientes.data.labels = dados.clientes.map(d => d.mes);
            charts.clientes.data.datasets[0].data = dados.clientes.map(d => d.ativos);
            charts.clientes.update();

            charts.faturamento.data.labels = dados.faturamento.map(d => d.mes);
            charts.faturamento.data.datasets[0].data = dados.faturamento.map(d => d.valor);
            charts.faturamento.update();

            charts.lucro.data.labels = dados.margem.map(d => d.mes);
            charts.lucro.data.datasets[0].data = dados.margem.map(d => d.receita - d.custos);
            charts.lucro.update();

            charts.mix.data.labels = dados.mix.map(d => d.mes);
            charts.mix.data.datasets[0].data = dados.mix.map(d => d.b2b);
            charts.mix.data.datasets[1].data = dados.mix.map(d => d.b2c);
            charts.mix.update();

            charts.nps.data.labels = dados.nps.map(d => d.mes);
            charts.nps.data.datasets[0].data = dados.nps.map(d => d.media);
            charts.nps.update();

            charts.margem.data.labels = dados.margem.map(d => d.mes);
            charts.margem.data.datasets[0].data = dados.margem.map(d => parseFloat(d.margem));
            charts.margem.update();
        }

        function changeTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            const buttons = document.querySelectorAll('.tab-button');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            buttons.forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }
    </script>
</body>
</html>
